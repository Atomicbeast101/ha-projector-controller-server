---
- name: Setup Projector Controller
  hosts: controller
  any_errors_fatal: true
  tasks:
    - name: Update apt packages
      apt:
        name: "*"
        state: latest
        update_cache: yes

    - name: Install apt packages
      apt:
        name: "{{ item }}"
      with_items:
        - ca-certificates
        - curl
        - gnupg
        - lsb-release
        - gpg

    - name: Add GPG Docker Key
      apt_key:
        url: https://download.docker.com/linux/raspbian/gpg
        dest: /etc/apt/keyrings/docker.gpg
        state: present

    - name: Add Docker repository
      apt_repository:
        repo: deb [arch={{ ansible_architecture }} signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/raspbian {{ ansible_distribution_release | lower }} stable
        state: present

    - name: Install docker-ce package
      apt:
        name: docker-ce

    - name: Install python3-pip package
      apt:
        name: python3-pip

    - name: Install docker modules for Python
      pip:
        name: "{{ item }}"
      with_items:
        - docker
        - docker-compose

    - name: Upload docker-compose.yml file
      template: 
        src: docker-compose.yml.j2
        dest: /root/docker-compose.yml
        owner: root
        group: root
        mode: 0744

    - name: Create & run docker containers
      docker_compose:
        project_src: /root
      register: output

    - name: Show docker-compose output
      ansible.builtin.debug:
        var: output
